<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senarai Sekolah - Pengurusan Peranti</title>
    <!-- Muat naik Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Tajuk Utama -->
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 pb-4 border-b border-gray-200">
            Sistem Pengurusan Peranti Sekolah
        </h1>

        <!-- Mesej Memuatkan -->
        <div id="loading-message" class="text-center text-gray-500 text-lg">
            <p>Memuatkan senarai sekolah...</p>
        </div>

        <!-- Grid Senarai Sekolah (Akan diisi oleh JavaScript) -->
        <div id="school-list-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Kad Sekolah akan dimasukkan di sini -->
        </div>

        <!-- Mesej Tiada Data -->
        <div id="no-data-message" class="hidden text-center text-gray-500 text-lg bg-white p-10 rounded-lg shadow">
            <p>Tiada data sekolah ditemui. Sila tambah peranti pada halaman butiran untuk memulakan.</p>
        </div>
    </div>

    <!-- Import Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            onSnapshot, 
            collection, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug');

        let userId = null;
        let deviceCollectionPath = '';
        let unsubscribeDevices = null;

        // Rujukan DOM
        const schoolListGrid = document.getElementById('school-list-grid');
        const loadingMessage = document.getElementById('loading-message');
        const noDataMessage = document.getElementById('no-data-message');

        // --- AUTH & INITIAL LOAD ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Pengguna disahkan:", user.uid);
                userId = user.uid;
                deviceCollectionPath = `/artifacts/${appId}/users/${userId}/devices`;
                
                // Mula mendengar (listen) untuk data peranti
                loadAndGroupSchools();
                
            } else {
                console.log("Tiada pengguna. Sila pastikan anda log masuk.");
                if (unsubscribeDevices) unsubscribeDevices();
                loadingMessage.textContent = 'Ralat: Pengesahan gagal. Sila muat semula.';
                loadingMessage.classList.add('text-red-500');
            }
        });

        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Ralat log masuk:", error);
                loadingMessage.textContent = 'Ralat: Gagal menyambung ke pangkalan data.';
                loadingMessage.classList.add('text-red-500');
            }
        })();

        // --- FUNGSI UTAMA ---

        function loadAndGroupSchools() {
            if (unsubscribeDevices) unsubscribeDevices(); // Hentikan listener lama

            const devicesRef = collection(db, deviceCollectionPath);

            unsubscribeDevices = onSnapshot(devicesRef, (snapshot) => {
                const schools = {}; // Objek untuk mengumpul data sekolah

                if (snapshot.empty) {
                    loadingMessage.classList.add('hidden');
                    noDataMessage.classList.remove('hidden');
                    schoolListGrid.innerHTML = ''; // Kosongkan grid
                    return;
                }

                // 1. Kumpul dan Kumpulan Data
                snapshot.docs.forEach((doc) => {
                    const device = doc.data();
                    const schoolName = device.schoolName;

                    if (!schoolName) return; // Abaikan peranti tanpa nama sekolah

                    // Jika sekolah belum ada dalam objek, cipta
                    if (!schools[schoolName]) {
                        schools[schoolName] = {
                            name: schoolName,
                            total: 0,
                            good: 0,
                            damaged: 0,
                        };
                    }

                    // Kira jumlah
                    schools[schoolName].total++;
                    
                    // Logik Baik/Rosak (sama seperti details.html)
                    const catatan = (device.catatan || '').toLowerCase();
                    if (catatan.includes('rosak')) {
                        schools[schoolName].damaged++;
                    } else {
                        schools[schoolName].good++;
                    }
                });

                // 2. Paparkan Data
                renderSchoolCards(Object.values(schools));

            }, (error) => {
                console.error("Ralat memuatkan data peranti:", error);
                loadingMessage.textContent = 'Ralat memuatkan data.';
                loadingMessage.classList.add('text-red-500');
            });
        }

        function renderSchoolCards(schoolDataArray) {
            // Sembunyikan mesej memuatkan & tiada data
            loadingMessage.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            
            // Kosongkan grid sebelum memaparkan data baru
            schoolListGrid.innerHTML = '';

            if (schoolDataArray.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            }

            // Cipta kad untuk setiap sekolah
            schoolDataArray.forEach(school => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-100 transition-shadow hover:shadow-lg';
                
                // Encode nama sekolah untuk URL (cth, "SMK PUJUT" menjadi "SMK%20PUJUT")
                const encodedSchoolName = encodeURIComponent(school.name);
                
                card.innerHTML = `
                    <h2 class="text-xl font-bold text-indigo-700 mb-4 truncate">${school.name}</h2>
                    
                    <div class="space-y-3 mb-5">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Jumlah Peranti:</span>
                            <span class="font-bold text-gray-800 text-base">${school.total}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Peranti Baik:</span>
                            <span class="font-bold text-green-600 text-base">${school.good}</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Peranti Rosak:</span>
                            <span class="font-bold text-red-600 text-base">${school.damaged}</span>
                        </div>
                    </div>
                    
                    <a href="details.html?nama=${encodedSchoolName}" class="inline-block w-full text-center bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                        Lihat Butiran
                    </a>
                `;
                
                schoolListGrid.appendChild(card);
            });
        }

    </script>

</body>
</html>
