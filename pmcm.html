<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borang Laporan PMCM Tahunan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Storan untuk input dalam jadual */
        .table-input {
            @apply w-full border border-gray-300 rounded-md shadow-sm p-1.5 text-xs focus:ring-indigo-500 focus:border-indigo-500;
        }
        .table-select {
            @apply w-full border border-gray-300 rounded-md shadow-sm p-1.5 text-xs bg-white focus:ring-indigo-500 focus:border-indigo-500;
        }
        .table-checkbox {
            @apply h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500;
        }
        .save-btn {
            @apply bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .saved-btn {
            @apply bg-green-500 text-white text-xs font-bold py-1 px-2 rounded cursor-not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-screen-xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-xl">
        
        <a href="index.html" class="text-indigo-600 hover:underline mb-4 inline-block text-sm">&larr; Kembali ke Papan Pemuka Utama</a>

        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 border-b border-gray-200 pb-4">
            Borang Semakan PMCM Tahunan
        </h1>

        <div class="mb-4 max-w-xs">
            <label for="year-selector" class="block text-sm font-medium text-gray-700">Sila Pilih Tahun Semakan:</label>
            <select id="year-selector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-lg text-lg font-bold p-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">--Pilih Tahun--</option>
                <option value="2023">2023</option>
                <option value="2024" selected>2024</option> <option value="2025">2025</option>
            </select>
        </div>

        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full bg-white divide-y divide-gray-200">
                <thead class="bg-gray-50 text-center">
                    <tr class="text-gray-600">
                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider align-middle">Bil</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider align-middle">Nama Sekolah</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider align-middle">No. Siri Peranti</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider align-middle">Nama Murid</th>
                        <th scope="col" class="px-2 py-3 text-center text-xs font-medium uppercase tracking-wider align-middle">Disemak</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider align-middle">Status</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider align-middle">Catatan</th>
                        <th scope="col" class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider align-middle">Tindakan</th>
                    </tr>
                </thead>
                <tbody id="pmcm-table-body" class="divide-y divide-gray-200">
                    <tr id="loading-row">
                        <td colspan="8" class="text-center p-5 text-gray-500">
                            Sila pilih tahun untuk memuatkan data peranti.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDocs, 
            setDoc, 
            collection, 
            query, 
            where,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('Debug'); // Tunjuk log untuk debugging

        let userId = null;
        let deviceCollectionPath = '';
        let pmcmCollectionPath = ''; // Laluan untuk koleksi PMCM baru

        // Rujukan DOM
        const yearSelector = document.getElementById('year-selector');
        const pmcmTableBody = document.getElementById('pmcm-table-body');
        const loadingRow = document.getElementById('loading-row');

        // --- AUTH & INITIAL LOAD ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("Pengguna disahkan:", user.uid);
                userId = user.uid;
                // Laluan koleksi peranti peribadi
                deviceCollectionPath = `/artifacts/${appId}/users/${userId}/devices`;
                // BARU: Laluan untuk koleksi semakan PMCM
                pmcmCollectionPath = `/artifacts/${appId}/users/${userId}/pmcm_checks`;
                
                // Muatkan data jika tahun telah dipilih
                if (yearSelector.value) {
                    loadAllDevicesAndChecks(parseInt(yearSelector.value));
                }
            } else {
                console.log("Tiada pengguna.");
                pmcmTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500">Ralat: Pengesahan gagal. Sila muat semula.</td></tr>';
            }
        });

        (async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Ralat log masuk:", error);
                pmcmTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500">Ralat: Gagal menyambung ke pangkalan data.</td></tr>';
            }
        })();
        
        // --- EVENT LISTENER ---
        
        // Muatkan data apabila tahun ditukar
        yearSelector.addEventListener('change', (e) => {
            const selectedYear = e.target.value;
            if (selectedYear) {
                loadAllDevicesAndChecks(parseInt(selectedYear));
            } else {
                pmcmTableBody.innerHTML = '<tr id="loading-row"><td colspan="8" class="text-center p-5 text-gray-500">Sila pilih tahun untuk memuatkan data peranti.</td></tr>';
            }
        });

        // --- FUNGSI UTAMA ---

        // Muatkan SEMUA peranti dan data semakan PMCM yang sedia ada untuk tahun tersebut
        async function loadAllDevicesAndChecks(year) {
            if (!userId) {
                console.log("Menunggu pengesahan...");
                return;
            }
            
            pmcmTableBody.innerHTML = '<tr id="loading-row"><td colspan="8" class="text-center p-5 text-gray-500 animate-pulse">Memuatkan data, sila tunggu...</td></tr>';
            
            try {
                // Langkah 1: Dapatkan SEMUA peranti dari koleksi 'devices'
                const devicesQuery = query(collection(db, deviceCollectionPath));
                const deviceSnapshot = await getDocs(devicesQuery);
                
                if (deviceSnapshot.empty) {
                    pmcmTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-5 text-red-500">Tiada data peranti ditemui. Sila tambah peranti di halaman sekolah dahulu.</td></tr>';
                    return;
                }

                // Langkah 2: Dapatkan SEMUA data PMCM yang sedia ada untuk TAHUN ini
                const checksRef = collection(db, pmcmCollectionPath);
                const checksQuery = query(checksRef, where("year", "==", year));
                const checksSnapshot = await getDocs(checksQuery);

                // Langkah 3: Cipta 'Map' untuk data semakan sedia ada (untuk carian pantas)
                // Kunci = deviceId, Nilai = data semakan
                const checksMap = new Map();
                checksSnapshot.forEach(doc => {
                    checksMap.set(doc.data().deviceId, doc.data());
                });
                
                console.log(`Menjumpai ${deviceSnapshot.size} peranti dan ${checksMap.size} rekod PMCM untuk ${year}.`);

                // Langkah 4: Paparkan jadual
                pmcmTableBody.innerHTML = ''; // Kosongkan jadual
                let bil = 1;
                
                deviceSnapshot.docs.forEach((deviceDoc) => {
                    const device = deviceDoc.data();
                    const deviceId = deviceDoc.id;
                    
                    // Semak jika ada data PMCM sedia ada untuk peranti ini
                    const existingCheck = checksMap.get(deviceId);
                    
                    // Panggil fungsi untuk memaparkan setiap baris
                    renderPmcmRow(bil++, device, deviceId, existingCheck, year);
                });

            } catch (error) {
                console.error("Ralat memuatkan data PMCM:", error);
                pmcmTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-5 text-red-500">Gagal memuatkan data: ${error.message}</td></tr>`;
            }
        }

        // Fungsi untuk memaparkan satu baris dalam jadual PMCM
        function renderPmcmRow(bil, device, deviceId, checkData, year) {
            const row = document.createElement('tr');
            row.className = "text-sm";
            row.setAttribute('data-device-id', deviceId); // Simpan ID peranti pada baris

            const isChecked = checkData?.disemak || false;
            const status = checkData?.status || '';
            const catatan = checkData?.catatan || '';
            
            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap text-gray-500">${bil}.</td>
                <td class="px-4 py-2 whitespace-nowrap font-medium text-gray-700">${device.schoolName || 'Tiada Sekolah'}</td>
                <td class="px-4 py-2 whitespace-nowrap text-gray-600">${device.noSiri || '---'}</td>
                <td class="px-4 py-2 whitespace-nowrap text-gray-600">${device.namaMurid || '---'}</td>
                <td class="px-2 py-2 whitespace-nowrap text-center">
                    <input type="checkbox" class="table-checkbox pmcm-disemak" ${isChecked ? 'checked' : ''}>
                </td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <select class="table-select pmcm-status">
                        <option value="" ${status === '' ? 'selected' : ''}>--Pilih--</option>
                        <option value="Baik" ${status === 'Baik' ? 'selected' : ''}>Baik</option>
                        <option value="Rosak" ${status === 'Rosak' ? 'selected' : ''}>Rosak</option>
                    </select>
                </td>
                <td class="px-3 py-2 whitespace-nowrap">
                    <input type="text" class="table-input pmcm-catatan" value="${catatan}">
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-center">
                    <button class="save-btn">Simpan</button>
                </td>
            `;
            
            const saveButton = row.querySelector('.save-btn');
            
            // Tambah event listener untuk butang 'Simpan'
            saveButton.addEventListener('click', async () => {
                // Dapatkan data dari input dalam baris ini
                const disemak = row.querySelector('.pmcm-disemak').checked;
                const status = row.querySelector('.pmcm-status').value;
                const catatan = row.querySelector('.pmcm-catatan').value;
                
                // Tetapkan butang kepada 'Menyimpan...'
                saveButton.textContent = 'Menyimpan...';
                saveButton.disabled = true;

                try {
                    // Cipta data untuk disimpan
                    const pmcmDoc = {
                        deviceId: deviceId,
                        schoolName: device.schoolName,
                        year: year,
                        disemak: disemak,
                        status: status,
                        catatan: catatan,
                        lastUpdated: new Date() // Simpan tarikh dikemas kini
                    };

                    // Gunakan ID unik = [DEVICE_ID]_[YEAR]
                    // Ini membenarkan 'upsert' (update atau insert jika belum wujud)
                    const docId = `${deviceId}_${year}`;
                    const docRef = doc(db, pmcmCollectionPath, docId);
                    
                    // Guna setDoc untuk cipta/tulis ganti
                    await setDoc(docRef, pmcmDoc);

                    // Beri maklum balas visual
                    saveButton.textContent = 'Disimpan';
                    saveButton.classList.remove('save-btn');
                    saveButton.classList.add('saved-btn');

                    // Kembali kepada 'Simpan' selepas 2 saat
                    setTimeout(() => {
                        saveButton.textContent = 'Simpan';
                        saveButton.classList.remove('saved-btn');
                        saveButton.classList.add('save-btn');
                        saveButton.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error("Ralat menyimpan data PMCM:", error);
                    saveButton.textContent = 'Ralat!';
                    saveButton.disabled = false;
                    alert(`Gagal menyimpan: ${error.message}`);
                }
            });

            pmcmTableBody.appendChild(row);
        }

    </script>

</body>
</html>
